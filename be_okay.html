<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>be_okay — visualizer</title>
<style>
  :root{
    --bg:#071c2c;
    --pink:#ff66c4;
    --text:#ffffff;
  }
  html,body{height:100%;margin:0;background:var(--bg);overflow:hidden;font-family: system-ui, ui-sans-serif, Segoe UI, Roboto, Helvetica, Arial;}
  .stage{position:relative; width:100%; height:100%; display:block;}

  /* full-screen sky */
  .sky {
    position:absolute; inset:0;
    background:
      radial-gradient(100% 120% at 50% 0%, rgba(255,176,230,.25), transparent 60%),
      linear-gradient(#0a2540, #12314d 65%, #1a3e5f);
    z-index:1;
  }

  /* canvases/effects */
  #stars{position:absolute; inset:0; width:100%; height:100%; z-index:2;}
  #twinkle{position:absolute; inset:0; pointer-events:none; z-index:3;}
  #twinkle i{
    position:absolute; font-style:normal; color:#ffe6ff; opacity:.0;
    filter: drop-shadow(0 0 8px rgba(255,255,255,.65));
    animation: tw 3.2s ease-in-out infinite;
  }
  @keyframes tw{
    0%,100%{ opacity:0; transform:scale(.6) rotate(0deg); }
    40%    { opacity:.95; transform:scale(1.1) rotate(8deg); }
    60%    { opacity:.75; transform:scale(1.0) rotate(-6deg); }
  }

  /* strobing gradient overlay (DROP) */
  .strobe{
    position:absolute; inset:0; pointer-events:none; opacity:0;
    background: radial-gradient(120% 120% at 50% 90%, rgba(255,255,0,.25), transparent 60%),
                conic-gradient(from 90deg, #ff66c4, #ffd166, #ff66c4);
    mix-blend-mode: screen;
    animation: strobePulse 400ms steps(2, end) infinite;
    transition: opacity .25s ease;
    z-index:5;
  }
  .strobe.on{ opacity:.9; }
  @keyframes strobePulse{
    0%{ filter:brightness(1) saturate(1); }
    50%{ filter:brightness(1.6) saturate(1.3); }
    100%{ filter:brightness(1) saturate(1); }
  }

  /* FX canvas for heart spray (DROP) */
  #fx{ position:absolute; inset:0; width:100%; height:100%; pointer-events:none; z-index:6; }

  /* light beams from the bottom (DROP) */
  .beams{ position:absolute; left:50%; bottom:0; width:0; height:60vh; pointer-events:none; opacity:0; transition:opacity .3s ease; z-index:7; }
  .beams.on{ opacity:.9; }
  .beams .beam{
    position:absolute; bottom:0; left:-6px; width:12px; height:100%;
    background: linear-gradient(180deg, rgba(255,255,255,.75), rgba(255,255,255,0));
    box-shadow: 0 0 24px rgba(255,255,255,.75);
    transform-origin: bottom center;
    animation: beamPulse 1.2s ease-in-out infinite;
    opacity:.75;
    mix-blend-mode: screen;
  }
  @keyframes beamPulse{
    0%,100%{ transform:scaleY(.8) rotate(var(--rot,0deg)); opacity:.55; }
    50%{ transform:scaleY(1) rotate(var(--rot,0deg)); opacity:1; }
  }

  /* big pulsing heart (DROP) */
  .bigHeart{
    position:absolute; left:50%; top:50%;
    transform:translate(-50%,-50%) rotate(0deg);
    font-size:clamp(72px, 14vw, 220px);
    text-shadow: 0 0 35px rgba(255,102,196,.65), 0 0 90px rgba(255,255,170,.45);
    will-change: transform, opacity;
    animation: heartPulse 1.1s ease-in-out infinite;
    pointer-events:none;
    z-index:8;
  }
  @keyframes heartPulse{
    0%  { transform:translate(-50%,-50%) scale(.92) rotate(-2deg); }
    50% { transform:translate(-50%,-50%) scale(1.06) rotate(2deg); }
    100%{ transform:translate(-50%,-50%) scale(.92) rotate(-2deg); }
  }

  /* INTRO lyric base */
  .lyric{
    position:absolute; left:50%; top:40vh; transform:translate(-50%,-50%);
    color:var(--text); font-weight:900; letter-spacing:.5px; text-align:center; line-height:1.1;
    text-shadow:0 0 25px rgba(255,102,196,.45), 0 2px 0 rgba(0,0,0,.35);
    filter: drop-shadow(0 10px 20px rgba(0,0,0,.45));
    pointer-events:none;
    z-index:9;
  }
  .lyric span{ 
    font-size:clamp(28px, 6vw, 64px);
    background: linear-gradient(90deg, #fff, var(--pink));
    -webkit-background-clip:text; background-clip:text; color:transparent;
  }

  /* INTRO animation variants (duration set per-lyric inline) */
  @keyframes floatUpFade {
    0%   { opacity:0; transform:translate(-50%, calc(-50% + 8px)) scale(.98); }
    18%  { opacity:1; transform:translate(-50%, -50%) scale(1); }
    100% { opacity:0; transform:translate(-50%, calc(-50% - 10px)) scale(1); }
  }
  @keyframes popUp {
    0%   { opacity:0; transform:translate(-50%, calc(-50% + 10px)) scale(.88); filter:brightness(1); }
    20%  { opacity:1; transform:translate(-50%, -50%) scale(2); filter:brightness(2); }
    45%  { opacity:1; transform:translate(-50%, -50%) scale(1.5);  filter:brightness(1.5); }
    100% { opacity:0; transform:translate(-50%, calc(-50% - 8px)) scale(1); }
  }
  @keyframes phaseUp {
    0%   { opacity:0; transform:translate(-50%, calc(-50% + 8px)); text-shadow: 0 0 0 rgba(255,102,196,.0), 0 0 0 rgba(255,255,170,.0); }
    15%  { opacity:1; transform:translate(-50%, -50%);           text-shadow: -2px 0 50px rgba(255,102,196,.8), 2px 0 10px rgba(255,255,170,.7); }
    45%  { opacity:1; transform:translate(-50%, -50%);           text-shadow: 2px 0 50px rgba(255,102,196,.7), -2px 0 8px rgba(255,255,170,.6); }
    75%  { opacity:1; transform:translate(-50%, -50%);           text-shadow: -1px 0 50px rgba(255,102,196,.8), 1px 0 6px rgba(255,255,170,.6); }
    100% { opacity:0; transform:translate(-50%, calc(-50% - 8px)); text-shadow: 0 0 0 rgba(255,102,196,0), 0 0 0 rgba(255,255,170,0); }
  }

  /* BUILDUP lines (unchanged; fade in then out quickly) */
  .bline{
    position:absolute; left:50%;
    transform:translateX(-50%);
    color:#ffffff; font-weight:900;
    letter-spacing:.5px; line-height:1.1; text-align:center;
    text-shadow:0 0 25px rgba(255,102,196,.45), 0 2px 0 rgba(0,0,0,.35);
    pointer-events:none; opacity:0; will-change:opacity, transform;
    animation: bInOut 1.4s ease-out forwards;
    font-size:clamp(20px, 4.3vw, 44px);
    z-index:9;
  }
  .bline.big{
    font-size:clamp(34px, 8vw, 92px);
    animation: bInOut 1.9s ease-out forwards;
  }
  @keyframes bInOut{
    0%   { opacity:0; transform:translate(-50%, 8px) scale(.98); }
    22%  { opacity:1; transform:translate(-50%, 0)   scale(1);   }
    70%  { opacity:1; transform:translate(-50%, -2px) scale(1);  }
    100% { opacity:0; transform:translate(-50%, -8px) scale(1);  }
  }

  /* DROP lyric lines: black text, bold, pink glow/outline (duration set inline) */
  .dropLine{
    position:absolute; left:50%;
    transform:translateX(-50%);
    top: 14vh; /* overridden per line */
    color:#000; font-weight:900; letter-spacing:.5px; line-height:1.1; text-align:center;
    -webkit-text-stroke: 2px var(--pink);
    text-shadow:
      0 0 10px rgba(255,102,196,.9),
      0 0 20px rgba(255,102,196,.6),
      0 2px 0 rgba(0,0,0,.25);
    pointer-events:none; opacity:0; will-change:opacity, transform;
    max-width:min(92vw, 1200px);
    font-size:clamp(22px, 5vw, 54px);
    z-index:11;
    animation-name: dLine;
    animation-timing-function: ease-out;
    animation-fill-mode: forwards;
  }
  @keyframes dLine{
    0%   { opacity:0; transform:translate(-50%, 8px); }
    20%  { opacity:1; transform:translate(-50%, 0); }
    80%  { opacity:1; transform:translate(-50%, -1px); }
    100% { opacity:0; transform:translate(-50%, -6px); }
  }

  /* outro text */
  .outro{
    position:absolute; inset:0; display:grid; place-items:center;
    color:#fff; font-weight:900; text-align:center;
    text-shadow:0 0 25px rgba(255,102,196,.55), 0 2px 0 rgba(0,0,0,.35);
    font-size:clamp(36px, 9vw, 140px);
    letter-spacing:.5px;
    opacity:0; transition:opacity .6s ease;
    z-index:12;
  }
  .outro.on{ opacity:1; }

  /* HUD (hidden until end or autoplay blocked) */
  .hud{position:absolute; left:1rem; bottom:1rem; display:flex; gap:.5rem; align-items:center; color:#e8f3ff; font-size:.9rem; opacity:.9; user-select:none; z-index:15;}
  .btn{appearance:none; border:0; padding:.6rem .9rem; border-radius:14px; background:#12314d; color:#e8f3ff; cursor:pointer}
  .btn:active{transform:translateY(1px)}
  input[type="range"]{accent-color:var(--pink)}
  .hidden{ display:none; }

  /* dev scrub bar */
  .devbar{
    position:absolute; left:50%; top:12px; transform:translateX(-50%);
    width:min(720px, 88vw);
    display:flex; gap:.6rem; align-items:center;
    background: rgba(10, 37, 64, .55);
    backdrop-filter: blur(6px);
    padding:.5rem .75rem; border-radius:14px;
    box-shadow: 0 6px 20px rgba(0,0,0,.25);
    z-index:20;
  }
  .devbar input[type="range"]{ flex:1; accent-color: var(--pink); }
  .devbar span{ color:#e8f3ff; font-size:.85rem; opacity:.95; min-width:3ch; text-align:center; }
</style>
</head>
<body>
  <div class="stage">
    <section class="sky">
      <canvas id="stars"></canvas>
      <div id="twinkle" aria-hidden="true"></div>
    </section>

    <!-- DROP effects -->
    <div id="strobe" class="strobe hidden"></div>
    <div id="beams" class="beams hidden" aria-hidden="true"></div>
    <canvas id="fx"></canvas>
    <div id="bigHeart" class="bigHeart hidden">❤</div>

    <!-- (legacy) intro lyric node not used now, but kept to avoid breaking anything -->
    <div id="lyric" class="lyric" style="display:none;"><span></span></div>

    <!-- dev scrub bar (for testing) -->
    <div class="devbar" id="devbar">
      <span id="cur">0:00</span>
      <input id="scrub" type="range" min="0" max="73" step="0.01" value="0" />
      <span id="dur">1:13</span>
    </div>

    <!-- controls (hidden until track ends or autoplay blocked) -->
    <div class="hud hidden" id="hud">
      <button id="play" class="btn">▶️ Play</button>
      <label>Vol <input id="vol" type="range" min="0" max="1" step="0.01" value="0.85"></label>
      <span id="t">0:00</span>
    </div>

    <!-- outro -->
    <div id="outro" class="outro hidden">I love you Aubrey</div>

    <audio id="audio" src="music/be_okay.mp3" preload="auto" crossorigin="anonymous"></audio>
  </div>

<script>
/* ======= timings (seconds) ======= */
const SECTIONS = {
  intro:   { start: 0.0,  end: 32.1 },
  buildup: { start: 32.1, end: 43.0 },
  drop:    { start: 43.0, end: 65.0 },
  outro:   { start: 65.0, end: 73.0 }
};

/* INTRO — per-lyric start (at) and duration (dur in ms), plus optional fx */
const INTRO_LINES = [
  { at:  2.0, text: "You're my starlight and",                                dur: 1800, fx: 'normal' },
  { at:  4.0, text: "I'm your skyline",                                       dur: 2200, fx: 'normal' },
  { at:  7.2, text: "Do you blame me?",                                       dur: 2000, fx: 'normal' },
  { at:  9, text: "I'm glad that we're alive!!!",                              dur: 2200, fx: 'normal' },
  { at: 11, text: "Your smile",                                             dur: 4000, fx: 'pop'  }, // ✨ special
  { at: 14, text: "It takes me past the bitterness and broken things",      dur: 4500, fx: 'normal' },
  { at: 19.2, text: "That's my medicine",                                     dur: 2200, fx: 'normal' },
  { at: 22, text: "That's why",                                             dur: 4000, fx: 'pop'    }, // 💥 special
  { at: 25, text: "We're running from the city to the open sea",            dur: 4200, fx: 'normal' },
  { at: 28.5, text: "Since you're here with me",                              dur: 3100, fx: 'normal' }
];

/* BUILDUP (unchanged — your exact cadence) */
const BUILDUP_ROWS = [12, 24, 36, 48];
const BUILDUP_DELAYS = [1, 2.35, 3.35, 4.6];

/* DROP — per-line start and duration (ms) */
const DROP_LINES = [
  { at: 43.5, text: "Follow me to the unknown",          dur: 2800 },
  { at: 46.0, text: "I will always be your home",        dur: 2800 },
  { at: 48.5, text: "I can show you where to go",        dur: 2800 },
  { at: 51.0, text: "You don't have to be alone",        dur: 2800 },
  { at: 54.0, text: "Follow me to the unknown",          dur: 2800 },
  { at: 56.5, text: "I will always be your home",        dur: 2800 },
  { at: 59.0, text: "I can show you where to go",        dur: 2800 },
  { at: 61.5, text: "You don't have to be alone",        dur: 2800 }
];

/* ======= elements ======= */
const stage  = document.querySelector('.stage');
const skyEl  = document.querySelector('.sky');
const audio  = document.getElementById('audio');
const hud    = document.getElementById('hud');
const playBt = document.getElementById('play');
const vol    = document.getElementById('vol');
const timeEl = document.getElementById('t');
const canvas = document.getElementById('stars');
const ctx    = canvas.getContext('2d');
const twinkle= document.getElementById('twinkle');
const scrub  = document.getElementById('scrub');
const curEl  = document.getElementById('cur');
const durEl  = document.getElementById('dur');
const strobe = document.getElementById('strobe');
const beams  = document.getElementById('beams');
const bigHeart = document.getElementById('bigHeart');
const outroEl = document.getElementById('outro');
const fx = document.getElementById('fx');
const fxc = fx.getContext('2d');

/* ======= sizing ======= */
function fitCanvas() {
  // stars canvas
  canvas.style.width  = skyEl.clientWidth + 'px';
  canvas.style.height = skyEl.clientHeight + 'px';
  const dpr = Math.max(1, Math.min(window.devicePixelRatio || 1, 2));
  canvas.width  = Math.floor(skyEl.clientWidth  * dpr);
  canvas.height = Math.floor(skyEl.clientHeight * dpr);
  ctx.setTransform(dpr,0,0,dpr,0,0);

  // fx canvas
  fx.style.width  = skyEl.clientWidth + 'px';
  fx.style.height = skyEl.clientHeight + 'px';
  fx.width  = Math.floor(skyEl.clientWidth  * dpr);
  fx.height = Math.floor(skyEl.clientHeight * dpr);
  fxc.setTransform(dpr,0,0,dpr,0,0);
}
window.addEventListener('resize', ()=>{ fitCanvas(); seedStars(); makeTwinkles(); });
fitCanvas();

/* ======= starfield ======= */
const STAR_COUNT = 140;
let stars = [];
function seedStars(){
  stars = Array.from({length: STAR_COUNT}, () => ({
    x: Math.random()*skyEl.clientWidth,
    y: Math.random()*skyEl.clientHeight,
    r: Math.random()*1.8 + 0.6,
    p: Math.random()*Math.PI*2,       // twinkle phase
    s: 1.5 + Math.random()*2.5,       // twinkle speed
    fadeStart: Infinity,              // per-star fade start time
    _fadeLen: 0.8
  }));
}
seedStars();

function drawStars(t){
  ctx.clearRect(0,0,skyEl.clientWidth, skyEl.clientHeight);
  for(const st of stars){
    const tw = 0.25 + 0.75 * (0.5+0.5*Math.sin(st.p + t*st.s));
    let a = tw;
    if (t >= st.fadeStart){
      const k = Math.min(1, (t - st.fadeStart) / (st._fadeLen || 0.8));
      a *= (1 - k); // fade down
    }
    if (a <= 0) continue;
    ctx.globalAlpha = a;
    ctx.fillStyle = 'white';
    ctx.beginPath();
    ctx.arc(st.x, st.y, st.r, 0, Math.PI*2);
    ctx.fill();
  }
  ctx.globalAlpha = 1;
}

/* ======= twinkle emojis (trackable for fading) ======= */
let twinkles = []; // [{el, fadeStart, fadeLen, stopping, _startOpacity}]
function makeTwinkles() {
  twinkle.innerHTML = '';
  twinkles = [];
  const w = skyEl.clientWidth, h = skyEl.clientHeight;
  const count = 22;
  for(let i=0;i<count;i++){
    const el = document.createElement('i');
    el.textContent = Math.random()<0.5 ? '✨' : '⭐';
    const size = 14 + Math.random()*22;
    el.style.left = (Math.random()*w|0) + 'px';
    el.style.top  = (Math.random()*h|0) + 'px';
    el.style.fontSize = size+'px';
    el.style.animationDelay = (Math.random()*3.2).toFixed(2)+'s';
    el.style.animationDuration = (2.6 + Math.random()*2.8).toFixed(2)+'s';
    twinkle.appendChild(el);
    twinkles.push({ el, fadeStart: Infinity, fadeLen: 0.7, stopping: false, _startOpacity: 1 });
  }
}
makeTwinkles();

/* ======= INTRO lyric spawner (per-lyric duration + special fx) ======= */
function spawnIntroLyric({ text, dur=1800, fx='normal' }){
  const el = document.createElement('div');
  el.className = 'lyric';
  el.innerHTML = `<span>${text}</span>`;
  // per-lyric animation
  const name = fx === 'pop' ? 'popUp' : (fx === 'phase' ? 'phaseUp' : 'floatUpFade');
  el.style.animation = `${name} ${dur}ms ease-out forwards`;
  stage.appendChild(el);
  // clean up after
  setTimeout(()=> el.remove(), dur + 120);
}

/* ======= BUILDUP lyrics (unchanged timings you gave) ======= */
let buildupNodes = [];
function spawnBuildupLyrics(){
  clearBuildupLyrics();
  const rows = [...BUILDUP_ROWS];
  const delays = [...BUILDUP_DELAYS];
  for(let i=0;i<4;i++){
    const el = document.createElement('div');
    el.className = 'bline';
    el.style.top = rows[i] + 'vh';
    el.style.animationDelay = delays[i] + 's';
    el.textContent = "It'll be okay";
    stage.appendChild(el);
    buildupNodes.push(el);
  }
  const big = document.createElement('div');
  big.className = 'bline big';
  big.style.top = '50vh';
  big.style.animationDelay = '7.8s';
  big.textContent = "It'll be okay <3";
  stage.appendChild(big);
  buildupNodes.push(big);
}
function clearBuildupLyrics(){
  for(const n of buildupNodes){ n.remove(); }
  buildupNodes = [];
}

/* ======= DROP lyric spawner (per-lyric duration) ======= */
const DROP_ROWS = [6, 14, 22, 30]; // top-half rows (vh)
let dropNodes = [];
function spawnDropLyric({ text, dur=2400 }, rowIndex){
  const el = document.createElement('div');
  el.className = 'dropLine';
  el.style.top = (DROP_ROWS[rowIndex % DROP_ROWS.length]) + 'vh';
  el.style.animationDuration = `${dur}ms`;
  el.textContent = text;
  stage.appendChild(el);
  dropNodes.push(el);
  setTimeout(()=> el.remove(), dur + 120);
}
function clearDropLyrics(){
  for(const n of dropNodes){ n.remove(); }
  dropNodes = [];
}

/* ======= fade schedulers ======= */
function fadeStarsOneByOne(totalDuration=2.2, perFade=0.8){
  const t0 = audio.currentTime || 0;
  const shuffled = [...stars].sort(()=>Math.random()-0.5);
  for(let i=0;i<shuffled.length;i++){
    const st = shuffled[i];
    const offset = (i / shuffled.length) * totalDuration;
    st.fadeStart = t0 + offset;
    st._fadeLen = perFade;
  }
}
function fadeTwinklesOneByOne(totalDuration=2.2, perFade=0.7){
  const t0 = audio.currentTime || 0;
  const shuffled = [...twinkles].sort(()=>Math.random()-0.5);
  for(let i=0;i<shuffled.length;i++){
    const tw = shuffled[i];
    const offset = (i / shuffled.length) * totalDuration;
    tw.fadeStart = t0 + offset;
    tw.fadeLen = perFade;
  }
}

/* ======= DROP visuals ======= */
function buildBeams(){
  beams.innerHTML = '';
  const count = 12;
  for(let i=0;i<count;i++){
    const b = document.createElement('div');
    b.className = 'beam';
    const rot = -35 + (70/(count-1))*i; // degrees
    b.style.setProperty('--rot', rot+'deg');
    b.style.animationDelay = (Math.random()*0.4).toFixed(2)+'s';
    beams.appendChild(b);
  }
}
function dropProgress(t){
  const d = SECTIONS.drop;
  return Math.min(1, Math.max(0, (t - d.start) / (d.end - d.start)));
}
let hearts = [];
let emitAccumulator = 0;

function heartPath(g, size=22){
  const s = size/16;
  g.beginPath();
  g.moveTo(0,-6*s);
  g.bezierCurveTo(6*s,-12*s, 16*s,-3*s, 0, 8*s);
  g.bezierCurveTo(-16*s,-3*s, -6*s,-12*s, 0,-6*s);
  g.closePath();
}
function emitBurst(dt, rate){
  emitAccumulator += dt * rate;
  let n = emitAccumulator | 0;
  emitAccumulator -= n;
  while(n-- > 0){
    const w = fx.clientWidth, h = fx.clientHeight;
    const x = w/2 + (Math.random()*80 - 40);
    const y = h + 10;
    const angle = (-Math.PI/2) + (Math.random()*Math.PI/6 - Math.PI/12);
    const speed = 220 + Math.random()*180;
    const rotSp = (Math.random()<0.5?-1:1) * (0.8 + Math.random()*1.8);
    const scale = 0.7 + Math.random()*0.9;
    hearts.push({
      x, y,
      vx: Math.cos(angle)*speed,
      vy: Math.sin(angle)*speed,
      rot: Math.random()*Math.PI*2,
      rotSp,
      life: 0,
      max: 1.6 + Math.random()*0.8,
      scale
    });
  }
}
function updateHearts(dt){
  const g = 300;
  for(const h of hearts){
    h.life += dt;
    h.vy += g*dt*0.2;
    h.x  += h.vx*dt;
    h.y  += h.vy*dt;
    h.rot+= h.rotSp*dt;
  }
  hearts = hearts.filter(h => h.life < h.max && h.y < fx.clientHeight + 80);
}
function drawHearts(){
  fxc.clearRect(0,0,fx.clientWidth, fx.clientHeight);
  for(const h of hearts){
    const a = 1 - (h.life / h.max);
    fxc.save();
    fxc.translate(h.x, h.y);
    fxc.rotate(h.rot);
    fxc.scale(h.scale, h.scale);
    fxc.globalAlpha = Math.max(0, a);
    // pink → yellow blend by lifetime
    const mix = 1 - a;
    const r = 255;
    const g = Math.floor(102 + mix*(214-102));
    const b = Math.floor(196 + mix*(102-196));
    fxc.fillStyle = `rgb(${r},${g},${Math.max(0,b)})`;
    heartPath(fxc, 22);
    fxc.fill();
    fxc.restore();
  }
}

/* ======= section handlers ======= */
function startDrop(){
  strobe.classList.remove('hidden'); strobe.classList.add('on');
  beams.classList.remove('hidden');  beams.classList.add('on'); buildBeams();
  bigHeart.classList.remove('hidden');
  hearts = []; emitAccumulator = 0;
}
function endDrop(){
  strobe.classList.remove('on'); strobe.classList.add('hidden');
  beams.classList.remove('on');  beams.classList.add('hidden'); beams.innerHTML = '';
  bigHeart.classList.add('hidden');
  hearts = [];
  fxc.clearRect(0,0,fx.clientWidth, fx.clientHeight);
}
function startOutro(){
  endDrop();
  clearBuildupLyrics();
  clearDropLyrics();
  outroEl.classList.remove('hidden');
  requestAnimationFrame(()=> outroEl.classList.add('on'));
}
function endOutro(){
  outroEl.classList.remove('on');
  setTimeout(()=>outroEl.classList.add('hidden'), 300);
}

/* ======= cues ======= */
const fired = new Set(); 
const CUES = [];
function addCue(key, at, fn){ CUES.push({ key, at, fn });}

addCue('intro-start', SECTIONS.intro.start, ()=>{ /* intro visuals already active */ });

// intro per-line cues (uses per-lyric durations + fx)
INTRO_LINES.forEach((c,i)=>{
  addCue(`intro-line-${i}`, c.at, ()=> spawnIntroLyric(c));
});

/* buildup (unchanged) */
addCue('buildup-start', SECTIONS.buildup.start, ()=>{
  fadeStarsOneByOne(2.2, 0.8);
  fadeTwinklesOneByOne(2.2, 0.7);
  spawnBuildupLyrics();
});

/* drop: start visuals + per-line lyrics */
addCue('drop-start', SECTIONS.drop.start, ()=>{
  clearBuildupLyrics();
  startDrop();
});
DROP_LINES.forEach((c,i)=>{
  addCue(`drop-line-${i}`, c.at, ()=> spawnDropLyric(c, i));
});

/* outro */
addCue('outro-start', SECTIONS.outro.start, ()=>{
  startOutro();
});

/* ======= main loop ======= */
let rafId = null;
let prevPlayT = 0;
function tick(){
  const t = audio.currentTime || 0;
  const dt = Math.max(0, t - prevPlayT);
  prevPlayT = t;

  drawStars(t);

  // fade twinkle emojis like stars
  for(const tw of twinkles){
    if (t >= tw.fadeStart){
      if (!tw.stopping){
        tw.stopping = true;
        tw.el.style.animation = 'none';
        tw._startOpacity = parseFloat(getComputedStyle(tw.el).opacity) || 1;
      }
      const k = Math.min(1, (t - tw.fadeStart) / (tw.fadeLen || 0.7));
      const op = (1 - k) * (tw._startOpacity ?? 1);
      tw.el.style.opacity = op.toFixed(3);
      if (k >= 1) tw.el.style.display = 'none';
    }
  }

  // DROP particles/effects
  if (t >= SECTIONS.drop.start && t < SECTIONS.drop.end){
    const p = dropProgress(t);
    const base = 18, extra = 1000;               // ~18 → ~108 hearts/sec
    const rate = base + extra*p;
    emitBurst(dt, rate);
    updateHearts(dt);
    drawHearts();
  } else {
    if (hearts.length){
      updateHearts(dt);
      drawHearts();
    } else {
      fxc.clearRect(0,0,fx.clientWidth, fx.clientHeight);
    }
  }

  // safety for scrubbing backward during testing
  if (t < SECTIONS.drop.start && !strobe.classList.contains('hidden')) endDrop();
  if (t < SECTIONS.outro.start && !outroEl.classList.contains('hidden')) endOutro();

  // cues
  for(const c of CUES){
    if(!fired.has(c.key) && t >= c.at){
      fired.add(c.key);
      try{ c.fn(); }catch(e){ console.error(e); }
    }
  }

  // hud + devbar time
  timeEl.textContent = fmt(t);
  scrub.value = t.toFixed(2);
  curEl.textContent = fmt(t);

  rafId = requestAnimationFrame(tick);
}
function fmt(sec){
  const m=Math.floor(sec/60);
  const s=Math.floor(sec%60).toString().padStart(2,'0');
  return `${m}:${s}`;
}

/* ======= playback / UI logic ======= */
function hideHud(){ hud.classList.add('hidden'); }
function showHud(){ hud.classList.remove('hidden'); }

function resetVisualization(){
  if(rafId) cancelAnimationFrame(rafId);
  clearBuildupLyrics();
  clearDropLyrics();
  endDrop();
  endOutro();
  fired.clear();
  seedStars();
  makeTwinkles();
  audio.currentTime = 0;
  prevPlayT = 0;
  scrub.value = 0;
  curEl.textContent = '0:00';
}

async function startPlayback(){
  hideHud();
  try{
    await audio.play();
    prevPlayT = audio.currentTime || 0;
    rafId = requestAnimationFrame(tick);
  }catch(err){
    showHud(); // Autoplay likely blocked
  }
}

/* events */
playBt.addEventListener('click', async ()=>{
  resetVisualization();
  await startPlayback();
});
vol.addEventListener('input', e=> audio.volume = parseFloat(e.target.value));
audio.volume = parseFloat(vol.value);

audio.addEventListener('loadedmetadata', ()=>{
  const d = Number.isFinite(audio.duration) ? audio.duration : SECTIONS.outro.end;
  scrub.max = d.toFixed(2);
  durEl.textContent = fmt(d);
});

audio.addEventListener('ended', ()=>{
  showHud(); // replay option
});

/* devbar seeking */
let wasPlaying = false;
scrub.addEventListener('mousedown', ()=> {
  wasPlaying = !audio.paused;
  if (wasPlaying) audio.pause();
});
scrub.addEventListener('input', e=>{
  const v = parseFloat(e.target.value || '0');
  audio.currentTime = v;
  prevPlayT = v; // avoid a giant dt spike after seeking
});
scrub.addEventListener('mouseup', ()=> {
  if (wasPlaying) audio.play().catch(()=>{ /* ignore */ });
});

/* attempt autoplay on load; if blocked, HUD appears for manual start */
window.addEventListener('DOMContentLoaded', async ()=>{
  await startPlayback();
});
</script>
</body>
</html>
